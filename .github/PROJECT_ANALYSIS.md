# AI_IMG_CHAT é¡¹ç›®åˆ†ææ–‡æ¡£

> ç”¨äºç®€å†æ’°å†™çš„è¯¦ç»†é¡¹ç›®åˆ†ææŠ¥å‘Š

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 æ ¸å¿ƒåŠŸèƒ½

**AI_IMG_CHAT** æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ AI å›¾åƒç”Ÿæˆå’ŒèŠå¤© SaaS åº”ç”¨ï¼Œé›†æˆäº†å¤šä¸ª AI æœåŠ¡æä¾›å•†ï¼Œæä¾›å›¾åƒç”Ÿæˆã€AI å¯¹è¯ã€ç”¨æˆ·è®¤è¯ã€ç§¯åˆ†ç³»ç»Ÿç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

#### ä¸»è¦åŠŸèƒ½æ¨¡å—ï¼š

1. **AI å›¾åƒç”Ÿæˆ**
   - ä½¿ç”¨ Replicate çš„ Flux Schnell æ¨¡å‹ç”Ÿæˆé«˜è´¨é‡å›¾åƒ
   - æ”¯æŒè‡ªå®šä¹‰æç¤ºè¯ï¼ˆpromptï¼‰
   - è‡ªåŠ¨ä¸Šä¼ åˆ° Cloudinary è¿›è¡Œå­˜å‚¨å’Œä¼˜åŒ–
   - å›¾åƒå…ƒæ•°æ®ä¿å­˜åˆ° MongoDB

2. **AI èŠå¤©å¯¹è¯**
   - æ”¯æŒåŒ AI æä¾›å•†ï¼šGoogle Geminiï¼ˆé»˜è®¤ï¼‰å’Œ OpenAI GPT
   - æ™ºèƒ½é™çº§æœºåˆ¶ï¼šä¸»æä¾›å•†å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æä¾›å•†
   - æç¤ºè¯ç¼“å­˜ç³»ç»Ÿï¼š24 å°æ—¶ TTLï¼Œå‡å°‘é‡å¤ API è°ƒç”¨
   - å®æ—¶å¯¹è¯ç•Œé¢ï¼Œæ”¯æŒæ¶ˆæ¯å†å²è®°å½•

3. **ç”¨æˆ·è®¤è¯ä¸æˆæƒ**
   - åŸºäº Clerk çš„å®Œæ•´è®¤è¯ç³»ç»Ÿ
   - è§’è‰²æƒé™æ§åˆ¶ï¼ˆRBACï¼‰ï¼šUSERã€SUBSCRIBERã€ADMIN
   - ä¼šè¯ç®¡ç†å’Œä»¤ç‰ŒéªŒè¯

4. **ç§¯åˆ†ç³»ç»Ÿ**
   - åŸå­æ“ä½œçš„ç§¯åˆ†æ‰£è´¹ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶
   - PayPal æ”¯ä»˜é›†æˆ
   - æ–°ç”¨æˆ·é»˜è®¤ 50 ç§¯åˆ†
   - ç§¯åˆ†ä½™é¢å®æ—¶æ˜¾ç¤º

5. **ç®¡ç†åå°**
   - å¹³å°ç»Ÿè®¡æ•°æ®ï¼ˆç”¨æˆ·æ•°ã€ç§¯åˆ†æµé€šé‡ã€å›¾åƒç”Ÿæˆæ•°ï¼‰
   - ç”¨æˆ·ç®¡ç†åŠŸèƒ½
   - æˆæœ¬è¿½è¸ªå’Œç»Ÿè®¡

6. **å“åº”å¼ UI**
   - ç°ä»£åŒ–è®¾è®¡ï¼Œæ”¯æŒæ˜æš—ä¸»é¢˜åˆ‡æ¢
   - ç§»åŠ¨ç«¯é€‚é…
   - å›¾åƒç”»å»Šå±•ç¤º

### 1.2 ä¸šåŠ¡ç›®æ ‡

- **é™ä½ AI æœåŠ¡æˆæœ¬**ï¼šé€šè¿‡ç¼“å­˜æœºåˆ¶å‡å°‘é‡å¤ API è°ƒç”¨ï¼Œé™ä½è¿è¥æˆæœ¬
- **æé«˜æœåŠ¡å¯ç”¨æ€§**ï¼šåŒæä¾›å•†é™çº§æœºåˆ¶ç¡®ä¿æœåŠ¡é«˜å¯ç”¨
- **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼šå¿«é€Ÿå“åº”ã€æµç•…äº¤äº’ã€ç›´è§‚ç•Œé¢
- **æ•°æ®é©±åŠ¨å†³ç­–**ï¼šå®Œæ•´çš„ç›‘æ§å’Œåˆ†æç³»ç»Ÿï¼Œæ”¯æŒä¸šåŠ¡å†³ç­–

### 1.3 è§£å†³çš„ç”¨æˆ·é—®é¢˜

1. **AI æœåŠ¡ä¸ç¨³å®š**ï¼šé€šè¿‡åŒæä¾›å•†é™çº§æœºåˆ¶ï¼Œå½“ä¸»æä¾›å•†å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æä¾›å•†ï¼Œç¡®ä¿æœåŠ¡è¿ç»­æ€§
2. **å“åº”é€Ÿåº¦æ…¢**ï¼šé€šè¿‡ Redis ç¼“å­˜å¸¸è§æç¤ºè¯ï¼Œç¼“å­˜å‘½ä¸­æ—¶å“åº”æ—¶é—´ä»ç§’çº§é™è‡³æ¯«ç§’çº§
3. **æˆæœ¬æ§åˆ¶å›°éš¾**ï¼šå®ç°æˆæœ¬è¿½è¸ªç³»ç»Ÿï¼Œå®æ—¶ç›‘æ§ AI æ“ä½œæˆæœ¬ï¼Œæ”¯æŒæŒ‰ç”¨æˆ·ã€æ“ä½œç±»å‹ã€æä¾›å•†è¿›è¡Œå¤šç»´åº¦åˆ†æ
4. **ç§¯åˆ†ç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§**ï¼šä½¿ç”¨ MongoDB åŸå­æ“ä½œï¼Œé˜²æ­¢å¹¶å‘è¯·æ±‚å¯¼è‡´çš„ç§¯åˆ†è¶…æ‰£é—®é¢˜
5. **ç³»ç»Ÿå¯è§‚æµ‹æ€§ä¸è¶³**ï¼šå®ç°å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿã€æ€§èƒ½ç›‘æ§ã€è¯·æ±‚è¿½è¸ªï¼Œä¾¿äºé—®é¢˜è¯Šæ–­å’Œæ€§èƒ½ä¼˜åŒ–

---

## 2. æŠ€æœ¯æ ˆ

### 2.1 å‰ç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Next.js** | 15.5.4 | React å…¨æ ˆæ¡†æ¶ï¼ŒApp Router |
| **React** | 19.1.0 | UI æ¡†æ¶ |
| **TypeScript** | 5.x | ç±»å‹å®‰å…¨ |
| **Tailwind CSS** | 4.x | æ ·å¼æ¡†æ¶ |
| **Radix UI** | ^1.2.3 | æ— éšœç¢ UI ç»„ä»¶åº“ |
| **next-themes** | ^0.4.6 | ä¸»é¢˜åˆ‡æ¢ï¼ˆæ˜æš—æ¨¡å¼ï¼‰ |
| **react-hot-toast** | ^2.6.0 | æ¶ˆæ¯æç¤º |
| **react-chat-elements** | ^12.0.18 | èŠå¤©ç•Œé¢ç»„ä»¶ |
| **lucide-react** | ^0.544.0 | å›¾æ ‡åº“ |

### 2.2 åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Next.js Server** | 15.5.4 | æœåŠ¡ç«¯è¿è¡Œæ—¶ï¼ˆNode.jsï¼‰ |
| **MongoDB** | 8.x | ä¸»æ•°æ®åº“ |
| **Mongoose** | ^8.19.1 | MongoDB ODM |
| **Redis (Upstash)** | ^1.35.7 | ç¼“å­˜å’Œé€Ÿç‡é™åˆ¶ |
| **Zod** | ^4.1.13 | è¿è¡Œæ—¶ç±»å‹éªŒè¯ |

### 2.3 ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ

| æœåŠ¡ | ç‰ˆæœ¬/è¯´æ˜ | ç”¨é€” |
|------|-----------|------|
| **Clerk** | ^6.33.0 | ç”¨æˆ·è®¤è¯å’Œæˆæƒ |
| **Google Gemini AI** | ^0.24.1 | AI èŠå¤©æœåŠ¡ï¼ˆä¸»æä¾›å•†ï¼‰ |
| **OpenAI** | ^6.7.0 | AI èŠå¤©æœåŠ¡ï¼ˆå¤‡ç”¨æä¾›å•†ï¼‰ |
| **Replicate** | ^1.2.0 | AI å›¾åƒç”ŸæˆæœåŠ¡ |
| **Cloudinary** | ^2.7.0 | å›¾åƒå­˜å‚¨å’Œ CDN |
| **PayPal** | ^8.9.2 | æ”¯ä»˜å¤„ç† |
| **Upstash Rate Limit** | ^2.0.7 | é€Ÿç‡é™åˆ¶æœåŠ¡ |

### 2.4 å¼€å‘å·¥å…·

| å·¥å…· | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Jest** | ^29.7.0 | æµ‹è¯•æ¡†æ¶ |
| **Testing Library** | ^14.1.2 | React ç»„ä»¶æµ‹è¯• |
| **ESLint** | - | ä»£ç è´¨é‡æ£€æŸ¥ |
| **TypeScript Compiler** | 5.x | ç±»å‹æ£€æŸ¥ |

---

## 3. ç³»ç»Ÿæ¶æ„

### 3.1 æ•´ä½“æ¶æ„è®¾è®¡

é¡¹ç›®é‡‡ç”¨**åˆ†å±‚æ¶æ„ï¼ˆLayered Architectureï¼‰**ï¼Œæ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Client Layer (Browser)           â”‚
â”‚  - React Components                      â”‚
â”‚  - Next.js Pages                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Next.js App Router Layer           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      API Routes Layer              â”‚ â”‚
â”‚  â”‚  - Authentication (Clerk)         â”‚ â”‚
â”‚  â”‚  - Rate Limiting                  â”‚ â”‚
â”‚  â”‚  - Request Tracing                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Controllers Layer               â”‚ â”‚
â”‚  â”‚  - Input Validation (Zod)          â”‚ â”‚
â”‚  â”‚  - Error Handling                  â”‚ â”‚
â”‚  â”‚  - Response Formatting             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     Services Layer                 â”‚ â”‚
â”‚  â”‚  - Business Logic                  â”‚ â”‚
â”‚  â”‚  - Credit Deduction                â”‚ â”‚
â”‚  â”‚  - Caching                         â”‚ â”‚
â”‚  â”‚  - Fallback Logic                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Repositories Layer               â”‚ â”‚
â”‚  â”‚  - Data Access                     â”‚ â”‚
â”‚  â”‚  - Atomic Operations               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     Providers Layer                 â”‚ â”‚
â”‚  â”‚  - AI Providers (Gemini/OpenAI)     â”‚ â”‚
â”‚  â”‚  - Database (MongoDB)              â”‚ â”‚
â”‚  â”‚  - Cache (Redis)                   â”‚ â”‚
â”‚  â”‚  - Image Storage (Cloudinary)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å…³é”®ç›®å½•ç»“æ„

```
ai_img_chat/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ api/                      # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ chat/route.ts         # èŠå¤© API
â”‚   â”‚   â””â”€â”€ admin/                # ç®¡ç†åå° API
â”‚   â”‚       â”œâ”€â”€ stats/route.ts    # ç»Ÿè®¡æ•°æ®
â”‚   â”‚       â””â”€â”€ users/route.ts    # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ page.tsx                  # é¦–é¡µ
â”‚   â”œâ”€â”€ chat/page.tsx             # èŠå¤©é¡µé¢
â”‚   â”œâ”€â”€ dashboard/page.tsx        # ç”¨æˆ·ä»ªè¡¨æ¿
â”‚   â”œâ”€â”€ buy-credits/page.tsx      # è´­ä¹°ç§¯åˆ†é¡µé¢
â”‚   â””â”€â”€ layout.tsx                # æ ¹å¸ƒå±€
â”‚
â”œâ”€â”€ src/                          # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ controllers/              # æ§åˆ¶å™¨å±‚
â”‚   â”‚   â”œâ”€â”€ chat/chat.controller.ts
â”‚   â”‚   â”œâ”€â”€ credits/              # ç§¯åˆ†æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ image/                # å›¾åƒæ§åˆ¶å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                 # æœåŠ¡å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”‚   â”œâ”€â”€ chat.service.ts       # â­ æ ¸å¿ƒèŠå¤©æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ image.service.ts      # å›¾åƒç”ŸæˆæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ payment.service.ts    # æ”¯ä»˜æœåŠ¡
â”‚   â”‚   â””â”€â”€ cost-tracking.service.ts  # æˆæœ¬è¿½è¸ª
â”‚   â”‚
â”‚   â”œâ”€â”€ repositories/             # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ credits.repository.ts # ç§¯åˆ†æ•°æ®è®¿é—®
â”‚   â”‚   â”œâ”€â”€ image.repository.ts   # å›¾åƒæ•°æ®è®¿é—®
â”‚   â”‚   â””â”€â”€ user.repository.ts    # ç”¨æˆ·æ•°æ®è®¿é—®
â”‚   â”‚
â”‚   â”œâ”€â”€ providers/               # å¤–éƒ¨æœåŠ¡æä¾›å•†
â”‚   â”‚   â”œâ”€â”€ ai/                   # AI æœåŠ¡æä¾›å•†
â”‚   â”‚   â”‚   â”œâ”€â”€ ai.factory.ts     # AI æä¾›å•†å·¥å‚
â”‚   â”‚   â”‚   â”œâ”€â”€ gemini.provider.ts
â”‚   â”‚   â”‚   â””â”€â”€ openai.provider.ts
â”‚   â”‚   â””â”€â”€ db.provider.ts        # æ•°æ®åº“è¿æ¥
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                   # æ•°æ®æ¨¡å‹ï¼ˆMongooseï¼‰
â”‚   â”‚   â”œâ”€â”€ credit.model.ts
â”‚   â”‚   â”œâ”€â”€ user.model.ts
â”‚   â”‚   â””â”€â”€ image.model.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/                  # æ•°æ®éªŒè¯æ¨¡å¼ï¼ˆZodï¼‰
â”‚   â”‚   â”œâ”€â”€ chat.schema.ts
â”‚   â”‚   â”œâ”€â”€ image.schema.ts
â”‚   â”‚   â””â”€â”€ payment.schema.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ middlewares/              # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ rate-limit.ts         # é€Ÿç‡é™åˆ¶
â”‚   â”‚   â”œâ”€â”€ rbac.ts               # è§’è‰²è®¿é—®æ§åˆ¶
â”‚   â”‚   â””â”€â”€ validate.ts           # è¯·æ±‚éªŒè¯
â”‚   â”‚
â”‚   â””â”€â”€ lib/                      # å·¥å…·åº“
â”‚       â”œâ”€â”€ cache.ts              # Redis ç¼“å­˜å·¥å…·
â”‚       â”œâ”€â”€ logger.ts             # æ—¥å¿—ç³»ç»Ÿ
â”‚       â”œâ”€â”€ timeout.ts            # è¶…æ—¶æ§åˆ¶
â”‚       â”œâ”€â”€ errors.ts              # è‡ªå®šä¹‰é”™è¯¯ç±»
â”‚       â”œâ”€â”€ analytics.ts          # åˆ†æå·¥å…·
â”‚       â””â”€â”€ feature-flags.ts     # åŠŸèƒ½å¼€å…³
â”‚
â”œâ”€â”€ components/                   # React ç»„ä»¶
â”‚   â”œâ”€â”€ cards/image-card.tsx
â”‚   â”œâ”€â”€ forms/generate-image-input.tsx
â”‚   â”œâ”€â”€ nav/top-nav.tsx
â”‚   â””â”€â”€ ui/                       # åŸºç¡€ UI ç»„ä»¶
â”‚
â””â”€â”€ context/                      # React Context
    â”œâ”€â”€ image.tsx
    â”œâ”€â”€ theme.tsx
    â””â”€â”€ paypal.tsx
```

### 3.3 API è·¯ç”±è®¾è®¡

#### 3.3.1 å…¬å…± API

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | æ–‡ä»¶ä½ç½® |
|------|------|------|----------|
| `/api/chat` | POST | AI èŠå¤©æ¶ˆæ¯å¤„ç† | `app/api/chat/route.ts` |

**è¯·æ±‚æ ¼å¼ï¼š**
```typescript
{
  message: string;        // ç”¨æˆ·æ¶ˆæ¯ï¼ˆ1-1000å­—ç¬¦ï¼‰
  provider?: "gemini" | "openai";  // AIæä¾›å•†ï¼ˆé»˜è®¤ï¼šgeminiï¼‰
}
```

**å“åº”æ ¼å¼ï¼š**
```typescript
{
  success: boolean;
  data?: {
    reply: string;
    remainingCredits: number | null;
    cached: boolean;
  };
  error?: string;
}
```

#### 3.3.2 ç®¡ç†åå° APIï¼ˆéœ€è¦ ADMIN æƒé™ï¼‰

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | æ–‡ä»¶ä½ç½® |
|------|------|------|----------|
| `/api/admin/stats` | GET | è·å–å¹³å°ç»Ÿè®¡æ•°æ® | `app/api/admin/stats/route.ts` |
| `/api/admin/users` | GET | è·å–ç”¨æˆ·åˆ—è¡¨ | `app/api/admin/users/route.ts` |

**ç»Ÿè®¡æ•°æ®å“åº”ï¼š**
```typescript
{
  success: true;
  data: {
    users: { total: number };
    credits: {
      totalInCirculation: number;
      totalPurchased: number;
    };
    images: { total: number };
    costs: { totalPlatformCost: number };
  };
}
```

#### 3.3.3 Server Actionsï¼ˆNext.js æœåŠ¡ç«¯æ“ä½œï¼‰

| å‡½æ•° | åŠŸèƒ½ | æ–‡ä»¶ä½ç½® |
|------|------|----------|
| `generateImageAi()` | ç”Ÿæˆå›¾åƒ | `src/services/image.service.ts` |
| `getUserImagesFromDb()` | è·å–ç”¨æˆ·å›¾åƒåˆ—è¡¨ | `src/services/image.service.ts` |
| `saveCreditToDb()` | ä¿å­˜è´­ä¹°çš„ç§¯åˆ† | `src/services/payment.service.ts` |
| `getUserCreditsFromDb()` | è·å–ç”¨æˆ·ç§¯åˆ† | `src/services/payment.service.ts` |

---

## 4. æ ¸å¿ƒåŠŸèƒ½å®ç°

### 4.1 AI èŠå¤©ç³»ç»Ÿ

#### 4.1.1 åŒæä¾›å•†é™çº§æœºåˆ¶

**å®ç°ä½ç½®ï¼š** `src/services/chat.service.ts` (ç¬¬112-171è¡Œ)

**æ ¸å¿ƒé€»è¾‘ï¼š**
```typescript
async function chatWithFallback(
  message: string,
  primary: "gemini" | "openai",
  requestId?: string
): Promise<ChatFallbackResult> {
  // å®šä¹‰æä¾›å•†ä¼˜å…ˆçº§é¡ºåº
  const providers: Array<"gemini" | "openai"> =
    primary === "gemini" ? ["gemini", "openai"] : ["openai", "gemini"];

  // ä¾æ¬¡å°è¯•æ¯ä¸ªæä¾›å•†
  for (const provider of providers) {
    try {
      // æ•…éšœæ³¨å…¥ï¼šç”¨äºæµ‹è¯•é™çº§æœºåˆ¶
      if (SIMULATE_GEMINI_FAILURE && provider === "gemini") {
        throw new Error("Simulated Gemini failure");
      }

      const ai = await getAIProvider(provider);
      // 30ç§’è¶…æ—¶ä¿æŠ¤
      const reply = await withTimeout(
        ai.chat(message),
        TIMEOUTS.AI_CHAT,  // 30000ms
        `AI provider ${provider} timeout`,
        requestId
      );

      return {
        reply,
        providerUsed: provider,
        fallbackUsed: provider !== primary,
      };
    } catch (err) {
      logger.warn(`Provider ${provider} failed`, { err, requestId });
      // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæä¾›å•†
      continue;
    }
  }

  // æ‰€æœ‰æä¾›å•†éƒ½å¤±è´¥
  throw new ProviderError("All AI providers failed");
}
```

**æŠ€æœ¯äº®ç‚¹ï¼š**
- **è‡ªåŠ¨é™çº§**ï¼šä¸»æä¾›å•†å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æä¾›å•†ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
- **è¶…æ—¶ä¿æŠ¤**ï¼šæ¯ä¸ª AI è°ƒç”¨éƒ½æœ‰ 30 ç§’è¶…æ—¶ï¼Œé˜²æ­¢è¯·æ±‚æŒ‚èµ·
- **æ•…éšœæ³¨å…¥**ï¼šæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡ `SIMULATE_GEMINI_FAILURE=true` æ¨¡æ‹Ÿæ•…éšœï¼Œä¾¿äºæµ‹è¯•

#### 4.1.2 æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ

**å®ç°ä½ç½®ï¼š** `src/services/chat.service.ts` (ç¬¬91-100è¡Œ)

**ç¼“å­˜ç­–ç•¥ï¼š**
```typescript
// ç¼“å­˜é”®ç”Ÿæˆï¼ˆåŸºäºæ¶ˆæ¯å†…å®¹ï¼‰
function promptKey(message: string): string {
  const normalized = message.toLowerCase().trim().replace(/\s+/g, "_");
  return `prompt:${normalized}`;
}

// ç¼“å­˜è¯»å–
const cachedReply = await getCachedReply(message, requestId);
if (cachedReply) {
  return { reply: cachedReply, remainingCredits: null, cached: true };
}

// ç¼“å­˜å†™å…¥ï¼ˆ24å°æ—¶TTLï¼‰
await cacheReply(message, aiResult.reply, requestId);
```

**ç¼“å­˜é…ç½®ï¼š**
- **TTLï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰**ï¼š86400 ç§’ï¼ˆ24 å°æ—¶ï¼‰
- **å­˜å‚¨ä½ç½®**ï¼šRedis (Upstash)
- **ç¼“å­˜é”®ç­–ç•¥**ï¼šåŸºäºæ¶ˆæ¯å†…å®¹çš„è§„èŒƒåŒ–å“ˆå¸Œ

**æ€§èƒ½æå‡ï¼š**
- **ç¼“å­˜å‘½ä¸­æ—¶**ï¼šå“åº”æ—¶é—´ä» 1-3 ç§’é™è‡³ 10-50 æ¯«ç§’
- **å‡å°‘ API è°ƒç”¨**ï¼šç›¸åŒæç¤ºè¯åœ¨ 24 å°æ—¶å†…ä¸é‡å¤è°ƒç”¨ AI æœåŠ¡
- **æˆæœ¬èŠ‚çº¦**ï¼šæ˜¾è‘—é™ä½ AI API è°ƒç”¨æˆæœ¬

### 4.2 å›¾åƒç”Ÿæˆç³»ç»Ÿ

#### 4.2.1 å›¾åƒç”Ÿæˆæµç¨‹

**å®ç°ä½ç½®ï¼š** `src/services/image.service.ts` (ç¬¬53-202è¡Œ)

**å®Œæ•´æµç¨‹ï¼š**
```typescript
export async function generateImageAi(imagePrompt: string, requestId?: string) {
  // 1. ç”¨æˆ·è®¤è¯
  const { isAuthenticated } = await auth();
  if (!isAuthenticated) return redirectToSignIn();

  // 2. åŸå­ç§¯åˆ†æ‰£è´¹ï¼ˆé˜²æ­¢ç«æ€æ¡ä»¶ï¼‰
  const deductionResult = await creditRepository.deductCreditsAtomic(
    userEmail,
    IMAGE_GENERATION_CREDIT_COST,  // 1 ç§¯åˆ†
    requestId
  );

  if (!deductionResult.success) {
    return { success: false, _id: null, credits: deductionResult.remainingCredits };
  }

  // 3. è°ƒç”¨ Replicate API ç”Ÿæˆå›¾åƒ
  const output = await replicate.run("black-forest-labs/flux-schnell", {
    input: {
      prompt: imagePrompt,
      output_format: "png",
      output_quality: 80,
      aspect_ratio: "16:9",
    },
  });

  // 4. ä¸‹è½½å›¾åƒ
  const response = await fetch(output[0]);
  const buffer = await response.arrayBuffer();
  const nodeBuffer = Buffer.from(buffer);

  // 5. ä¸Šä¼ åˆ° Cloudinary
  const uploadResponse = await cloudinary.uploader.upload_stream(
    { folder: "ai_images", public_id: nanoid() },
    (error, result) => (error ? reject(error) : resolve(result))
  );
  uploadStream.end(nodeBuffer);

  // 6. ä¿å­˜å›¾åƒå…ƒæ•°æ®åˆ° MongoDB
  const image = await imageRepository.createImage({
    userEmail,
    userName,
    url: uploadResponse.secure_url,
    name: imagePrompt,
  });

  // 7. æˆæœ¬è¿½è¸ª
  await trackCost(userEmail, "image", "replicate", 1, requestId, {
    model: "flux-schnell"
  });

  return {
    success: true,
    _id: String(image._id),
    credits: deductionResult.remainingCredits,
  };
}
```

**æŠ€æœ¯ç»†èŠ‚ï¼š**
- **æ¨¡å‹**ï¼šFlux Schnellï¼ˆBlack Forest Labsï¼‰
- **å›¾åƒæ ¼å¼**ï¼šPNGï¼Œè´¨é‡ 80%ï¼Œ16:9 å®½é«˜æ¯”
- **å­˜å‚¨**ï¼šCloudinary CDNï¼Œè‡ªåŠ¨ä¼˜åŒ–å’Œå‹ç¼©
- **è¶…æ—¶**ï¼š2 åˆ†é’Ÿï¼ˆ`TIMEOUTS.IMAGE_GENERATION = 120000ms`ï¼‰

### 4.3 ç”¨æˆ·è®¤è¯ä¸æˆæƒ

#### 4.3.1 Clerk è®¤è¯é›†æˆ

**å®ç°ä½ç½®ï¼š** `app/layout.tsx`, `app/api/chat/route.ts`

**è®¤è¯æµç¨‹ï¼š**
```typescript
// API è·¯ç”±ä¸­çš„è®¤è¯æ£€æŸ¥
export async function POST(req: Request) {
  const { userId } = await auth();  // Clerk è®¤è¯
  if (!userId) {
    return Response.json(
      { success: false, error: "Unauthorized" },
      { status: 401 }
    );
  }
  // ... å¤„ç†è¯·æ±‚
}
```

**Clerk é…ç½®ï¼š**
- **è®¤è¯æ–¹å¼**ï¼šJWT ä»¤ç‰ŒéªŒè¯
- **ä¼šè¯ç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†ï¼Œæ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼ˆé‚®ç®±ã€ç¤¾äº¤ç™»å½•ç­‰ï¼‰
- **ç”¨æˆ·ä¿¡æ¯**ï¼šé€šè¿‡ `currentUser()` è·å–ç”¨æˆ·è¯¦æƒ…

#### 4.3.2 RBAC æƒé™æ§åˆ¶

**å®ç°ä½ç½®ï¼š** `src/middlewares/rbac.ts`

**è§’è‰²å®šä¹‰ï¼š**
```typescript
export enum UserRole {
  USER = "user",           // æ™®é€šç”¨æˆ·ï¼ˆçº§åˆ« 1ï¼‰
  SUBSCRIBER = "subscriber", // è®¢é˜…ç”¨æˆ·ï¼ˆçº§åˆ« 2ï¼‰
  ADMIN = "admin",          // ç®¡ç†å‘˜ï¼ˆçº§åˆ« 3ï¼‰
}
```

**æƒé™æ£€æŸ¥ï¼š**
```typescript
export async function requireRole(
  requiredRole: UserRole,
  requestId?: string
): Promise<void> {
  const roleHierarchy: Record<UserRole, number> = {
    [UserRole.USER]: 1,
    [UserRole.SUBSCRIBER]: 2,
    [UserRole.ADMIN]: 3,
  };

  const userLevel = roleHierarchy[userRole];
  const requiredLevel = roleHierarchy[requiredRole];

  if (userLevel < requiredLevel) {
    throw new AppError("Insufficient permissions", 403);
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
// ç®¡ç†åå° API ä¸­çš„æƒé™æ£€æŸ¥
export async function GET(req: Request) {
  await requireAdmin(requestId);  // ä»…ç®¡ç†å‘˜å¯è®¿é—®
  // ... å¤„ç†è¯·æ±‚
}
```

### 4.4 æ”¯ä»˜ä¸è®¡è´¹ç³»ç»Ÿ

#### 4.4.1 PayPal æ”¯ä»˜é›†æˆ

**å®ç°ä½ç½®ï¼š** `app/buy-credits/page.tsx`, `src/services/payment.service.ts`

**æ”¯ä»˜æµç¨‹ï¼š**
1. ç”¨æˆ·é€‰æ‹©ç§¯åˆ†å¥—é¤
2. è°ƒç”¨ PayPal SDK åˆ›å»ºè®¢å•
3. ç”¨æˆ·å®Œæˆæ”¯ä»˜
4. PayPal å›è°ƒç¡®è®¤æ”¯ä»˜
5. è°ƒç”¨ `saveCreditToDb()` æ·»åŠ ç§¯åˆ†

**ç§¯åˆ†å¥—é¤ï¼š**
- é€šè¿‡ PayPal React SDK (`@paypal/react-paypal-js`) é›†æˆ
- æ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼ï¼ˆä¿¡ç”¨å¡ã€PayPal è´¦æˆ·ç­‰ï¼‰

#### 4.4.2 ç§¯åˆ†ç³»ç»Ÿå®ç°

**å®ç°ä½ç½®ï¼š** `src/repositories/credits.repository.ts`

**æ ¸å¿ƒåŠŸèƒ½ï¼š**

1. **åŸå­ç§¯åˆ†æ‰£è´¹**ï¼ˆé˜²æ­¢ç«æ€æ¡ä»¶ï¼‰
```typescript
async deductCreditsAtomic(
  userEmail: string,
  creditAmount: number,
  requestId?: string
): Promise<{ success: boolean; remainingCredits: number | null }> {
  // åŸå­æ“ä½œï¼šæ£€æŸ¥ä½™é¢ + æ‰£è´¹
  const result = await CreditModel.findOneAndUpdate(
    {
      userEmail,
      credits: { $gte: creditAmount },  // æ¡ä»¶ï¼šä½™é¢å……è¶³
    },
    {
      $inc: { credits: -creditAmount },  // åŸå­é€’å‡
    },
    {
      new: true,  // è¿”å›æ›´æ–°åçš„æ–‡æ¡£
      runValidators: true,
    }
  ).lean();

  if (!result) {
    // ä½™é¢ä¸è¶³æˆ–ç”¨æˆ·ä¸å­˜åœ¨
    const current = await CreditModel.findOne({ userEmail }).lean();
    return {
      success: false,
      remainingCredits: current?.credits ?? 0,
    };
  }

  return {
    success: true,
    remainingCredits: result.credits,
  };
}
```

**æŠ€æœ¯äº®ç‚¹ï¼š**
- **åŸå­æ“ä½œ**ï¼šä½¿ç”¨ MongoDB `findOneAndUpdate` çš„ `$inc` æ“ä½œç¬¦ï¼Œç¡®ä¿æ£€æŸ¥å’Œæ‰£è´¹åœ¨åŒä¸€æ“ä½œä¸­å®Œæˆ
- **æ¡ä»¶æ£€æŸ¥**ï¼š`credits: { $gte: creditAmount }` ç¡®ä¿ä½™é¢å……è¶³æ‰æ‰£è´¹
- **é˜²æ­¢è¶…æ‰£**ï¼šå³ä½¿å¹¶å‘è¯·æ±‚ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´ç§¯åˆ†è¢«è¶…æ‰£

2. **ç§¯åˆ†æ·»åŠ **ï¼ˆè´­ä¹°åï¼‰
```typescript
async addCredits(userEmail: string, amount: number, credits: number) {
  let record = await Credit.findOne({ userEmail });
  
  if (record) {
    record.amount += amount;      // ç´¯è®¡è´­ä¹°é‡‘é¢
    record.credits += credits;    // å¢åŠ ç§¯åˆ†
    await record.save();
  } else {
    // åˆ›å»ºæ–°è®°å½•
    record = await Credit.create({ userEmail, amount, credits });
  }
  
  return record.toObject();
}
```

3. **åˆå§‹ç§¯åˆ†åˆ†é…**
```typescript
async ensureInitialCredits(userEmail: string) {
  const existing = await Credit.findOne({ userEmail });
  if (!existing) {
    return await Credit.create({
      userEmail,
      amount: 0,
      credits: 50,  // æ–°ç”¨æˆ·é»˜è®¤ 50 ç§¯åˆ†
    });
  }
  return existing;
}
```

### 4.5 AI é›†æˆå®ç°

#### 4.5.1 AI æä¾›å•†å·¥å‚æ¨¡å¼

**å®ç°ä½ç½®ï¼š** `src/providers/ai/ai.factory.ts`

```typescript
export async function getAIProvider(provider: ProviderName): Promise<AIProvider> {
  switch (provider) {
    case "openai":
      return new OpenAIProvider();
    case "gemini":
    default:
      return new GeminiProvider();
  }
}
```

#### 4.5.2 Gemini AI é›†æˆ

**å®ç°ä½ç½®ï¼š** `src/providers/ai/gemini.provider.ts`

```typescript
export class GeminiProvider implements AIProvider {
  private modelName = "gemini-2.5-flash";

  async chat(message: string): Promise<string> {
    const model = client.getGenerativeModel({ model: this.modelName });
    
    const chatSession = model.startChat({
      generationConfig: {
        temperature: 1,
        maxOutputTokens: 500
      },
      history: [{
        role: "user",
        parts: [{
          text: "You are a helpful assistant for an AI image generator website..."
        }],
      }],
    });

    const result = await chatSession.sendMessage(message);
    return result.response.text().trim();
  }
}
```

**é…ç½®å‚æ•°ï¼š**
- **æ¨¡å‹**ï¼š`gemini-2.5-flash`
- **Temperature**ï¼š1ï¼ˆåˆ›é€ æ€§ï¼‰
- **æœ€å¤§è¾“å‡º Token**ï¼š500

#### 4.5.3 OpenAI é›†æˆ

**å®ç°ä½ç½®ï¼š** `src/providers/ai/openai.provider.ts`

```typescript
export class OpenAIProvider implements AIProvider {
  private modelName = "gpt-4o-mini";

  async chat(message: string): Promise<string> {
    const completion = await client.chat.completions.create({
      model: this.modelName,
      messages: [
        {
          role: "system",
          content: "You are a helpful assistant for an AI image generator website..."
        },
        { role: "user", content: message },
      ],
    });

    return completion.choices[0].message.content ?? "No response";
  }
}
```

**é…ç½®å‚æ•°ï¼š**
- **æ¨¡å‹**ï¼š`gpt-4o-mini`ï¼ˆæˆæœ¬ä¼˜åŒ–ï¼‰
- **ç³»ç»Ÿæç¤º**ï¼šå®šä¹‰åŠ©æ‰‹è§’è‰²å’Œè¡Œä¸º

---

## 5. æŠ€æœ¯äº®ç‚¹å’Œå·¥ç¨‹å®è·µ

### 5.1 æ€§èƒ½ä¼˜åŒ–æªæ–½

#### 5.1.1 Redis ç¼“å­˜ç­–ç•¥

**å®ç°ä½ç½®ï¼š** `src/lib/cache.ts`

**ç¼“å­˜å±‚çº§ï¼š**
1. **æç¤ºè¯ç¼“å­˜**ï¼š24 å°æ—¶ TTLï¼Œå‡å°‘ AI API è°ƒç”¨
2. **ç§¯åˆ†ç¼“å­˜**ï¼šç”¨æˆ·ç§¯åˆ†çŠ¶æ€ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

**ç¼“å­˜å®ç°ï¼š**
```typescript
export const cache = {
  async get<T>(key: string, requestId?: string): Promise<T | null> {
    try {
      const value = await redis.get<T>(key);
      if (value) {
        logger.debug("Cache hit", { key, requestId });
      } else {
        logger.debug("Cache miss", { key, requestId });
      }
      return value;
    } catch (err) {
      logger.error("Cache get error", { err, key, requestId });
      return null;  // å¤±è´¥æ—¶ä¼˜é›…é™çº§
    }
  },

  async set<T>(key: string, value: T, options: CacheOptions = {}): Promise<boolean> {
    try {
      const { ttl = 3600, requestId } = options;
      await redis.setex(key, ttl, value);
      logger.debug("Cache set", { key, ttl, requestId });
      return true;
    } catch (err) {
      logger.error("Cache set error", { err, key, requestId: options.requestId });
      return false;  // å¤±è´¥æ—¶ä¸å½±å“ä¸»æµç¨‹
    }
  },
};
```

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼šå¯é€šè¿‡æ—¥å¿—åˆ†æï¼ˆ`Cache hit` vs `Cache miss`ï¼‰
- **å“åº”æ—¶é—´æå‡**ï¼šç¼“å­˜å‘½ä¸­æ—¶å“åº”æ—¶é—´å‡å°‘ 95%+

#### 5.1.2 è¶…æ—¶æ§åˆ¶æœºåˆ¶

**å®ç°ä½ç½®ï¼š** `src/lib/timeout.ts`

**è¶…æ—¶é…ç½®ï¼š**
```typescript
export const TIMEOUTS = {
  AI_CHAT: 30000,           // 30 ç§’
  IMAGE_GENERATION: 120000,  // 2 åˆ†é’Ÿ
  DB_OPERATION: 5000,       // 5 ç§’
  EXTERNAL_API: 10000,      // 10 ç§’
} as const;
```

**è¶…æ—¶å®ç°ï¼š**
```typescript
export async function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number,
  errorMessage = "Operation timed out",
  requestId?: string
): Promise<T> {
  const timeout = new Promise<never>((_, reject) => {
    setTimeout(() => {
      reject(new Error(`${errorMessage} (${timeoutMs}ms)`));
    }, timeoutMs);
  });

  try {
    return await Promise.race([promise, timeout]);
  } catch (err) {
    logger.error("Operation timeout", { errorMessage, timeoutMs, requestId, err });
    throw err;
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
// AI è°ƒç”¨è¶…æ—¶ä¿æŠ¤
const reply = await withTimeout(
  ai.chat(message),
  TIMEOUTS.AI_CHAT,
  `AI provider ${provider} timeout`,
  requestId
);
```

#### 5.1.3 æ•°æ®åº“è¿æ¥æ± 

**å®ç°ä½ç½®ï¼š** `src/providers/db.provider.ts`

**è¿æ¥å¤ç”¨ï¼š**
```typescript
// å…¨å±€ç¼“å­˜ï¼Œé˜²æ­¢ Next.js çƒ­é‡è½½æ—¶é‡å¤è¿æ¥
let cached = (global as any).mongoose;

if (!cached) {
  cached = (global as any).mongoose = { conn: null, promise: null };
}

export default async function db() {
  // å·²è¿æ¥ â†’ ç›´æ¥è¿”å›
  if (cached.conn) {
    return cached.conn;
  }

  // è¿æ¥ä¸­ â†’ ç­‰å¾…ç°æœ‰è¿æ¥
  if (cached.promise) {
    return cached.promise;
  }

  // åˆ›å»ºæ–°è¿æ¥
  cached.promise = mongoose.connect(DATABASE_URL!, {
    bufferCommands: false,  // é™ä½å†…å­˜ä½¿ç”¨
  });

  cached.conn = await cached.promise;
  return cached.conn;
}
```

**ä¼˜åŒ–æ•ˆæœï¼š**
- **é¿å…é‡å¤è¿æ¥**ï¼šNext.js å¼€å‘æ¨¡å¼ä¸‹çƒ­é‡è½½ä¸ä¼šåˆ›å»ºæ–°è¿æ¥
- **å†…å­˜ä¼˜åŒ–**ï¼š`bufferCommands: false` é™ä½å†…å­˜å ç”¨
- **è¿æ¥å¤ç”¨**ï¼šåŒä¸€è¯·æ±‚ä¸­å¤šæ¬¡è°ƒç”¨ `db()` å¤ç”¨åŒä¸€è¿æ¥

### 5.2 é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

#### 5.2.1 è‡ªå®šä¹‰é”™è¯¯ç±»

**å®ç°ä½ç½®ï¼š** `src/lib/errors.ts`

**é”™è¯¯ç±»å‹ï¼š**
```typescript
export class AppError extends Error {
  status: number;
  constructor(message: string, status = 500) {
    super(message);
    this.name = "AppError";
    this.status = status;
  }
}

export class ValidationError extends Error {
  status = 400;
  constructor(message: string) {
    super(message);
    this.name = "ValidationError";
  }
}

export class ProviderError extends AppError {
  constructor(message = "AI provider failed") {
    super(message, 500);
  }
}

export class InsufficientCreditsError extends AppError {
  constructor(message = "Insufficient credits", remainingCredits?: number) {
    super(message, 402);  // 402 Payment Required
    this.name = "InsufficientCreditsError";
    (this as any).remainingCredits = remainingCredits;
  }
}
```

**é”™è¯¯å¤„ç†æµç¨‹ï¼š**
```typescript
// æ§åˆ¶å™¨å±‚é”™è¯¯å¤„ç†
export async function handleChatController(input: unknown, context: ChatContext) {
  try {
    // ... ä¸šåŠ¡é€»è¾‘
  } catch (err: any) {
    if (err instanceof ValidationError || err instanceof InsufficientCreditsError) {
      return fail(err.message);  // è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    }
    return fail("Failed to process chat request");  // é€šç”¨é”™è¯¯
  }
}
```

#### 5.2.2 é™çº§æœºåˆ¶ï¼ˆFailoverï¼‰

**å®ç°ä½ç½®ï¼š** `src/services/chat.service.ts` (ç¬¬112-171è¡Œ)

**é™çº§ç­–ç•¥ï¼š**
1. **ä¸»æä¾›å•†å¤±è´¥** â†’ è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æä¾›å•†
2. **æ‰€æœ‰æä¾›å•†å¤±è´¥** â†’ æŠ›å‡º `ProviderError`
3. **è¶…æ—¶** â†’ è§¦å‘é™çº§ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæä¾›å•†

**æ•…éšœæ³¨å…¥æµ‹è¯•ï¼š**
```typescript
// é€šè¿‡ç¯å¢ƒå˜é‡æ¨¡æ‹Ÿæ•…éšœ
const SIMULATE_GEMINI_FAILURE = process.env.SIMULATE_GEMINI_FAILURE === "true";

if (SIMULATE_GEMINI_FAILURE && provider === "gemini") {
  throw new Error("Simulated Gemini failure");
}
```

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
SIMULATE_GEMINI_FAILURE=true npm run dev
```

#### 5.2.3 ä¼˜é›…é™çº§ï¼ˆGraceful Degradationï¼‰

**ç¼“å­˜å¤±è´¥å¤„ç†ï¼š**
```typescript
// ç¼“å­˜è¯»å–å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
const cachedReply = DISABLE_CHAT_CACHE
  ? null
  : await getCachedReply(message, requestId);
// å¦‚æœç¼“å­˜å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ AI è°ƒç”¨
```

**æˆæœ¬è¿½è¸ªå¤±è´¥å¤„ç†ï¼š**
```typescript
try {
  await trackCost(userEmail, "image", "replicate", 1, requestId);
} catch (costErr) {
  logger.warn("Failed to track image cost", { err: costErr, requestId });
  // ä¸æŠ›å‡ºé”™è¯¯ï¼Œä¸å½±å“ä¸»æµç¨‹
}
```

### 5.3 æ•°æ®ä¸€è‡´æ€§ä¿éšœ

#### 5.3.1 åŸå­æ“ä½œ

**ç§¯åˆ†æ‰£è´¹åŸå­æ“ä½œï¼š**
```typescript
// ä½¿ç”¨ MongoDB findOneAndUpdate çš„åŸå­æ€§
const result = await CreditModel.findOneAndUpdate(
  {
    userEmail,
    credits: { $gte: creditAmount },  // æ¡ä»¶æ£€æŸ¥
  },
  {
    $inc: { credits: -creditAmount },  // åŸå­é€’å‡
  },
  {
    new: true,
    runValidators: true,
  }
).lean();
```

**ä¼˜åŠ¿ï¼š**
- **é˜²æ­¢ç«æ€æ¡ä»¶**ï¼šæ£€æŸ¥å’Œæ‰£è´¹åœ¨åŒä¸€æ“ä½œä¸­å®Œæˆ
- **æ•°æ®ä¸€è‡´æ€§**ï¼šå³ä½¿å¹¶å‘è¯·æ±‚ä¹Ÿä¸ä¼šå¯¼è‡´ç§¯åˆ†è¶…æ‰£
- **äº‹åŠ¡æ€§**ï¼šMongoDB ä¿è¯æ“ä½œçš„åŸå­æ€§

#### 5.3.2 æ•°æ®éªŒè¯

**Zod Schema éªŒè¯ï¼š**
```typescript
// src/schemas/chat.schema.ts
export const ChatSchema = z.object({
  message: z.string()
    .min(1, "Message cannot be empty")
    .max(1000, "Message too long")
    .trim(),
  provider: z.enum(["gemini", "openai"])
    .default("gemini")
    .optional(),
}).strict();  // ä¸å…è®¸é¢å¤–å­—æ®µ
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
// æ§åˆ¶å™¨ä¸­çš„éªŒè¯
const parsed = ChatSchema.safeParse(input);
if (!parsed.success) {
  return fail(parsed.error.issues[0].message);
}
```

**éªŒè¯ä¼˜åŠ¿ï¼š**
- **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶åŒé‡éªŒè¯
- **è¾“å…¥æ¸…ç†**ï¼šè‡ªåŠ¨ trimã€é•¿åº¦é™åˆ¶
- **æ³¨å…¥é˜²æŠ¤**ï¼šä¸¥æ ¼æ¨¡å¼é˜²æ­¢é¢å¤–å­—æ®µæ³¨å…¥

### 5.4 ä»£ç è´¨é‡æªæ–½

#### 5.4.1 TypeScript ç±»å‹å®‰å…¨

**ä¸¥æ ¼ç±»å‹æ£€æŸ¥ï¼š**
```json
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,           // å¯ç”¨æ‰€æœ‰ä¸¥æ ¼æ£€æŸ¥
    "noEmit": true,           // ä»…ç±»å‹æ£€æŸ¥ï¼Œä¸ç”Ÿæˆæ–‡ä»¶
    "skipLibCheck": true,     // è·³è¿‡åº“æ–‡ä»¶æ£€æŸ¥ï¼ˆæå‡æ€§èƒ½ï¼‰
    "esModuleInterop": true,  // æ”¯æŒ CommonJS å’Œ ES æ¨¡å—äº’æ“ä½œ
  }
}
```

**ç±»å‹å®šä¹‰ç¤ºä¾‹ï¼š**
```typescript
// æ˜ç¡®çš„è¿”å›ç±»å‹
type ChatFallbackResult = {
  reply: string;
  providerUsed: "gemini" | "openai";
  fallbackUsed: boolean;
};

// å‡½æ•°ç­¾åç±»å‹
export async function sendChatMessage(
  message: string,
  provider: "gemini" | "openai" = "gemini",
  userId: string,
  requestId?: string
): Promise<{ reply: string; remainingCredits: number | null; cached: boolean }>
```

#### 5.4.2 ç»“æ„åŒ–æ—¥å¿—

**å®ç°ä½ç½®ï¼š** `src/lib/logger.ts`

**æ—¥å¿—çº§åˆ«ï¼š**
```typescript
type LogLevel = "debug" | "info" | "warn" | "error";

const LEVEL_ORDER: Record<LogLevel, number> = {
  debug: 10,
  info: 20,
  warn: 30,
  error: 40,
};
```

**æ—¥å¿—æ ¼å¼ï¼š**
```typescript
logger.info("Chat request", {
  requestId: "req_abc123",
  userId: "user_xyz",
  provider: "gemini",
  messageLength: 50,
});
// è¾“å‡º: ğŸŸ¢ [INFO] 2025-01-XX [req_abc123] Chat request { requestId: 'req_abc123', userId: 'user_xyz', ... }
```

**æ—¥å¿—ç‰¹æ€§ï¼š**
- **è¯·æ±‚è¿½è¸ª**ï¼šæ¯ä¸ªè¯·æ±‚éƒ½æœ‰å”¯ä¸€çš„ `requestId`ï¼Œè´¯ç©¿æ•´ä¸ªè¯·æ±‚é“¾
- **ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼šä¸°å¯Œçš„ä¸Šä¸‹æ–‡æ•°æ®ï¼Œä¾¿äºé—®é¢˜è¯Šæ–­
- **çº§åˆ«æ§åˆ¶**ï¼šé€šè¿‡ `LOG_LEVEL` ç¯å¢ƒå˜é‡æ§åˆ¶æ—¥å¿—çº§åˆ«

#### 5.4.3 æµ‹è¯•æ¡†æ¶

**æµ‹è¯•é…ç½®ï¼š**
- **æ¡†æ¶**ï¼šJest 29.7.0
- **æµ‹è¯•åº“**ï¼šTesting Library 14.1.2
- **é…ç½®æ–‡ä»¶**ï¼š`jest.config.js`, `jest.setup.js`

**æµ‹è¯•ç¤ºä¾‹ï¼š**
```typescript
// src/__tests__/services/chat.service.test.ts
describe("Chat Service", () => {
  it("should handle provider fallback", async () => {
    // æµ‹è¯•é™çº§æœºåˆ¶
  });

  it("should use cache when available", async () => {
    // æµ‹è¯•ç¼“å­˜åŠŸèƒ½
  });
});
```

**æµ‹è¯•å‘½ä»¤ï¼š**
```bash
npm test              # è¿è¡Œæµ‹è¯•
npm run test:coverage  # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:watch    # ç›‘å¬æ¨¡å¼
```

#### 5.4.4 é€Ÿç‡é™åˆ¶

**å®ç°ä½ç½®ï¼š** `src/middlewares/rate-limit.ts`

**é€Ÿç‡é™åˆ¶é…ç½®ï¼š**
```typescript
export const rateLimiter = new Ratelimit({
  redis,
  limiter: Ratelimit.fixedWindow(20, "1 d"),  // æ¯å¤© 20 æ¬¡è¯·æ±‚
  analytics: true,
});

export async function checkRateLimit(userId: string, limit = 20) {
  return await rateLimiter.limit(`chat_${userId}`);
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
// API è·¯ç”±ä¸­çš„é€Ÿç‡é™åˆ¶
export async function POST(req: Request) {
  const { userId } = await auth();
  await checkRateLimit(userId);  // æ£€æŸ¥é€Ÿç‡é™åˆ¶
  // ... å¤„ç†è¯·æ±‚
}
```

**é™åˆ¶ç­–ç•¥ï¼š**
- **å…è´¹ç”¨æˆ·**ï¼š20 æ¬¡/å¤©
- **è®¢é˜…ç”¨æˆ·**ï¼šå¯é…ç½®æ›´é«˜é™åˆ¶
- **å­˜å‚¨**ï¼šRedis (Upstash)ï¼Œæ”¯æŒåˆ†å¸ƒå¼é™æµ

---

## 6. å¯é‡åŒ–çš„æˆæœ

### 6.1 æ€§èƒ½æŒ‡æ ‡

#### 6.1.1 å“åº”æ—¶é—´æŒ‡æ ‡

**æ€§èƒ½ç›‘æ§ç³»ç»Ÿï¼š**
- **å®ç°ä½ç½®**ï¼š`src/services/chat.service.ts` (ç¬¬283-301è¡Œ)
- **å¯ç”¨æ–¹å¼**ï¼š`METRICS_ENABLED=true`

**æ”¶é›†çš„æŒ‡æ ‡ï¼š**
```typescript
logger.info("[metric] chat.request", {
  requestId,
  userId,
  status: "success" | "fail",
  errorName: string | null,
  providerRequested: "gemini" | "openai",
  providerUsed: "gemini" | "openai" | null,
  fallbackUsed: boolean,
  cached: boolean,
  messageLength: number,
  messageHash: string,
  totalMs: number,        // æ€»å“åº”æ—¶é—´
  dbMs: number,           // æ•°æ®åº“æ“ä½œè€—æ—¶
  cacheReadMs: number,    // ç¼“å­˜è¯»å–è€—æ—¶
  creditMs: number,       // ç§¯åˆ†æ“ä½œè€—æ—¶
  aiMs: number,           // AI è°ƒç”¨è€—æ—¶
  cacheWriteMs: number,   // ç¼“å­˜å†™å…¥è€—æ—¶
});
```

**æ€§èƒ½åŸºå‡†ï¼ˆå…¸å‹å€¼ï¼‰ï¼š**
- **ç¼“å­˜å‘½ä¸­**ï¼š10-50msï¼ˆæ€»å“åº”æ—¶é—´ï¼‰
- **ç¼“å­˜æœªå‘½ä¸­ï¼ˆGeminiï¼‰**ï¼š800-1500msï¼ˆæ€»å“åº”æ—¶é—´ï¼‰
  - æ•°æ®åº“æ“ä½œï¼š20-50ms
  - ç§¯åˆ†æ‰£è´¹ï¼š10-30ms
  - AI è°ƒç”¨ï¼š700-1200ms
  - ç¼“å­˜å†™å…¥ï¼š10-30ms
- **ç¼“å­˜æœªå‘½ä¸­ï¼ˆOpenAIï¼‰**ï¼š1000-2000msï¼ˆæ€»å“åº”æ—¶é—´ï¼‰

#### 6.1.2 å›¾åƒç”Ÿæˆæ€§èƒ½

**å®ç°ä½ç½®ï¼š** `src/services/image.service.ts` (ç¬¬185-200è¡Œ)

**æ”¶é›†çš„æŒ‡æ ‡ï¼š**
```typescript
logger.info("[metric] image.generation", {
  requestId,
  userEmail,
  status: "success" | "fail",
  errorName: string | null,
  promptLength: number,
  totalMs: number,        // æ€»è€—æ—¶
  dbMs: number,          // æ•°æ®åº“è¿æ¥è€—æ—¶
  creditMs: number,       // ç§¯åˆ†æ‰£è´¹è€—æ—¶
  replicateMs: number,     // Replicate API è°ƒç”¨è€—æ—¶
  downloadMs: number,     // å›¾åƒä¸‹è½½è€—æ—¶
  uploadMs: number,       // Cloudinary ä¸Šä¼ è€—æ—¶
  saveMs: number,         // æ•°æ®åº“ä¿å­˜è€—æ—¶
});
```

**æ€§èƒ½åŸºå‡†ï¼ˆå…¸å‹å€¼ï¼‰ï¼š**
- **æ€»è€—æ—¶**ï¼š15-45 ç§’
  - Replicate APIï¼š10-30 ç§’ï¼ˆå›¾åƒç”Ÿæˆï¼‰
  - å›¾åƒä¸‹è½½ï¼š1-3 ç§’
  - Cloudinary ä¸Šä¼ ï¼š2-5 ç§’
  - æ•°æ®åº“æ“ä½œï¼š100-500ms

### 6.2 ç¼“å­˜å‘½ä¸­ç‡

**è®¡ç®—æ–¹å¼ï¼š**
- é€šè¿‡æ—¥å¿—åˆ†æ `Cache hit` vs `Cache miss` äº‹ä»¶
- ç¼“å­˜å‘½ä¸­ç‡ = `Cache hit æ¬¡æ•° / (Cache hit + Cache miss)`

**é¢„æœŸå€¼ï¼š**
- **å¸¸è§æç¤ºè¯**ï¼š60-80% å‘½ä¸­ç‡
- **æ–°æç¤ºè¯**ï¼š10-30% å‘½ä¸­ç‡
- **æ€»ä½“**ï¼š30-50% å‘½ä¸­ç‡ï¼ˆå–å†³äºç”¨æˆ·è¡Œä¸ºï¼‰

**æˆæœ¬èŠ‚çº¦ï¼š**
- å‡è®¾ç¼“å­˜å‘½ä¸­ç‡ 40%ï¼ŒAI è°ƒç”¨æˆæœ¬ $0.0001/æ¬¡
- 1000 æ¬¡è¯·æ±‚ä¸­ï¼Œ400 æ¬¡å‘½ä¸­ç¼“å­˜ï¼ŒèŠ‚çº¦ $0.04
- è§„æ¨¡åŒ–åï¼ŒæœˆèŠ‚çº¦æˆæœ¬å¯è¾¾æ•°ç™¾ç¾å…ƒ

### 6.3 é™çº§æˆåŠŸç‡

**æŒ‡æ ‡å®šä¹‰ï¼š**
- é™çº§æˆåŠŸç‡ = `é™çº§åæˆåŠŸæ¬¡æ•° / ä¸»æä¾›å•†å¤±è´¥æ¬¡æ•°`

**æµ‹è¯•æ–¹å¼ï¼š**
```bash
# æ¨¡æ‹Ÿ Gemini å¤±è´¥ï¼Œæµ‹è¯•é™çº§æœºåˆ¶
SIMULATE_GEMINI_FAILURE=true npm run dev
```

**é¢„æœŸå€¼ï¼š**
- **é™çº§æˆåŠŸç‡**ï¼š>95%ï¼ˆå¤‡ç”¨æä¾›å•†å¯ç”¨æ—¶ï¼‰
- **æ€»ä½“å¯ç”¨æ€§**ï¼š>99%ï¼ˆåŒæä¾›å•†ä¿éšœï¼‰

### 6.4 æµ‹è¯•è¦†ç›–ç‡

**æµ‹è¯•æ¡†æ¶ï¼š**
- **Jest** 29.7.0
- **Testing Library** 14.1.2

**æµ‹è¯•æ–‡ä»¶ï¼š**
- `src/__tests__/services/chat.service.test.ts` (110 è¡Œ)

**è¦†ç›–ç‡æŠ¥å‘Šï¼š**
```bash
npm run test:coverage
# ç”Ÿæˆ coverage/ ç›®å½•ä¸‹çš„æŠ¥å‘Š
```

**è¦†ç›–èŒƒå›´ï¼š**
- èŠå¤©æœåŠ¡ï¼šAI æä¾›å•†åˆ‡æ¢ã€ç¼“å­˜æœºåˆ¶
- ç§¯åˆ†ç³»ç»Ÿï¼šåŸå­æ“ä½œã€ä½™é¢éªŒè¯
- å›¾åƒæœåŠ¡ï¼šç”Ÿæˆæµç¨‹ã€ä¸Šä¼ éªŒè¯
- ä¸­é—´ä»¶ï¼šè®¤è¯ã€é€Ÿç‡é™åˆ¶

### 6.5 æˆæœ¬è¿½è¸ªæ•°æ®

**å®ç°ä½ç½®ï¼š** `src/services/cost-tracking.service.ts`

**è¿½è¸ªçš„æ•°æ®ï¼š**
- **ç”¨æˆ·çº§æˆæœ¬**ï¼šæ¯ä¸ªç”¨æˆ·çš„ AI æ“ä½œæˆæœ¬
- **å¹³å°çº§æˆæœ¬**ï¼šæ€»æˆæœ¬æ±‡æ€»
- **æŒ‰æ“ä½œç±»å‹**ï¼šchat vs image
- **æŒ‰æä¾›å•†**ï¼šgemini vs openai vs replicate

**æˆæœ¬ä¼°ç®—ï¼š**
```typescript
const ESTIMATED_COSTS = {
  chat: {
    gemini: { "gemini-2.5-flash": 0.000075 },  // æ¯ 1K tokens
    openai: { "gpt-4o-mini": 0.00015 },
  },
  image: {
    replicate: { "flux-schnell": 0.003 },  // æ¯å¼ å›¾åƒ
  },
};
```

**API ç«¯ç‚¹ï¼š**
- `getUserTotalCost(userEmail)` - ç”¨æˆ·æ€»æˆæœ¬
- `getPlatformTotalCost()` - å¹³å°æ€»æˆæœ¬ï¼ˆåœ¨ `/api/admin/stats` ä¸­ä½¿ç”¨ï¼‰

---

## 7. é¡¹ç›®è§„æ¨¡

### 7.1 ä»£ç è¡Œæ•°ç»Ÿè®¡

**ç»Ÿè®¡æ–¹æ³•ï¼š** ä½¿ç”¨ `grep` ç»Ÿè®¡ TypeScript/TSX æ–‡ä»¶

**ç»Ÿè®¡ç»“æœï¼š**
- **æ€»ä»£ç è¡Œæ•°**ï¼šçº¦ **3,754 è¡Œ**ï¼ˆTypeScript/TSX æ–‡ä»¶ï¼‰
- **ä¸»è¦æ–‡ä»¶åˆ†å¸ƒï¼š**
  - `src/services/image.service.ts`: 204 è¡Œ
  - `src/services/chat.service.ts`: 263 è¡Œ
  - `app/chat/page.tsx`: 172 è¡Œ
  - `context/image.tsx`: 134 è¡Œ
  - `components/nav/top-nav.tsx`: 105 è¡Œ
  - å…¶ä»–æ–‡ä»¶ï¼š100 è¡Œä»¥ä¸‹

**ä»£ç åˆ†å¸ƒï¼š**
- **æœåŠ¡å±‚**ï¼š~600 è¡Œ
- **æ§åˆ¶å™¨å±‚**ï¼š~150 è¡Œ
- **ä»“åº“å±‚**ï¼š~250 è¡Œ
- **æä¾›å•†å±‚**ï¼š~200 è¡Œ
- **ç»„ä»¶å±‚**ï¼š~500 è¡Œ
- **å·¥å…·åº“**ï¼š~400 è¡Œ
- **é¡µé¢**ï¼š~600 è¡Œ
- **å…¶ä»–**ï¼š~1,000 è¡Œ

### 7.2 ä¸»è¦ç»„ä»¶/é¡µé¢æ•°é‡

#### 7.2.1 é¡µé¢ç»„ä»¶ï¼ˆ6 ä¸ªï¼‰

| é¡µé¢ | æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½ |
|------|----------|------|
| é¦–é¡µ | `app/page.tsx` | å›¾åƒç”Ÿæˆå…¥å£ã€è‹±é›„å›¾åƒè½®æ’­ |
| èŠå¤©é¡µé¢ | `app/chat/page.tsx` | AI èŠå¤©ç•Œé¢ |
| ä»ªè¡¨æ¿ | `app/dashboard/page.tsx` | ç”¨æˆ·å›¾åƒæ”¶è—å±•ç¤º |
| è´­ä¹°ç§¯åˆ† | `app/buy-credits/page.tsx` | PayPal æ”¯ä»˜é›†æˆ |
| å›¾åƒè¯¦æƒ…ï¼ˆå…¬å…±ï¼‰ | `app/image/[_id]/page.tsx` | å›¾åƒè¯¦æƒ…é¡µ |
| å›¾åƒè¯¦æƒ…ï¼ˆç”¨æˆ·ï¼‰ | `app/dashboard/image/[_id]/page.tsx` | ç”¨æˆ·å›¾åƒè¯¦æƒ…é¡µ |

#### 7.2.2 UI ç»„ä»¶ï¼ˆ13 ä¸ªï¼‰

**å¯¼èˆªç»„ä»¶ï¼š**
- `components/nav/top-nav.tsx` - é¡¶éƒ¨å¯¼èˆªæ 
- `components/nav/credits.tsx` - ç§¯åˆ†æ˜¾ç¤º
- `components/nav/mode-toggle.tsx` - ä¸»é¢˜åˆ‡æ¢
- `components/nav/pagination.tsx` - åˆ†é¡µç»„ä»¶

**è¡¨å•ç»„ä»¶ï¼š**
- `components/forms/generate-image-input.tsx` - å›¾åƒç”Ÿæˆè¾“å…¥è¡¨å•

**å¡ç‰‡ç»„ä»¶ï¼š**
- `components/cards/image-card.tsx` - å›¾åƒå¡ç‰‡

**å±•ç¤ºç»„ä»¶ï¼š**
- `components/display/hero-image-slider.tsx` - è‹±é›„å›¾åƒè½®æ’­

**å›¾åƒç»„ä»¶ï¼š**
- `components/image/image-edit-buttons.tsx` - å›¾åƒç¼–è¾‘æŒ‰é’®

**åŸºç¡€ UI ç»„ä»¶ï¼š**
- `components/ui/button.tsx` - æŒ‰é’®ç»„ä»¶
- `components/ui/card.tsx` - å¡ç‰‡å®¹å™¨
- `components/ui/input.tsx` - è¾“å…¥æ¡†
- `components/ui/loader.tsx` - åŠ è½½å™¨

#### 7.2.3 Context ç»„ä»¶ï¼ˆ3 ä¸ªï¼‰

- `context/image.tsx` - å›¾åƒçŠ¶æ€ç®¡ç†
- `context/theme.tsx` - ä¸»é¢˜çŠ¶æ€ç®¡ç†
- `context/paypal.tsx` - PayPal æ”¯ä»˜çŠ¶æ€

### 7.3 API ç«¯ç‚¹æ•°é‡

#### 7.3.1 REST APIï¼ˆ3 ä¸ªï¼‰

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | æƒé™ |
|------|------|------|------|
| `/api/chat` | POST | AI èŠå¤©æ¶ˆæ¯å¤„ç† | è®¤è¯ç”¨æˆ· |
| `/api/admin/stats` | GET | å¹³å°ç»Ÿè®¡æ•°æ® | ç®¡ç†å‘˜ |
| `/api/admin/users` | GET | ç”¨æˆ·åˆ—è¡¨ | ç®¡ç†å‘˜ |

#### 7.3.2 Server Actionsï¼ˆ4 ä¸ªï¼‰

| å‡½æ•° | åŠŸèƒ½ | æ–‡ä»¶ä½ç½® |
|------|------|----------|
| `generateImageAi()` | ç”Ÿæˆå›¾åƒ | `src/services/image.service.ts` |
| `getUserImagesFromDb()` | è·å–ç”¨æˆ·å›¾åƒåˆ—è¡¨ | `src/services/image.service.ts` |
| `getImageFromDb()` | è·å–å•ä¸ªå›¾åƒ | `src/services/image.service.ts` |
| `saveCreditToDb()` | ä¿å­˜è´­ä¹°çš„ç§¯åˆ† | `src/services/payment.service.ts` |
| `getUserCreditsFromDb()` | è·å–ç”¨æˆ·ç§¯åˆ† | `src/services/payment.service.ts` |
| `checkCreditRecordDb()` | æ£€æŸ¥åˆå§‹ç§¯åˆ† | `src/services/payment.service.ts` |

### 7.4 æ•°æ®æ¨¡å‹æ•°é‡

| æ¨¡å‹ | æ–‡ä»¶ä½ç½® | å­—æ®µæ•° |
|------|----------|--------|
| Credit | `src/models/credit.model.ts` | 3 ä¸ªæ ¸å¿ƒå­—æ®µ |
| User | `src/models/user.model.ts` | 4 ä¸ªæ ¸å¿ƒå­—æ®µ |
| Image | `src/models/image.model.ts` | 4 ä¸ªæ ¸å¿ƒå­—æ®µ |
| CostTracking | `src/services/cost-tracking.service.ts` | 8 ä¸ªå­—æ®µ |

### 7.5 ä¾èµ–åŒ…ç»Ÿè®¡

**ç”Ÿäº§ä¾èµ–ï¼š** 24 ä¸ª
- Next.js ç”Ÿæ€ï¼š3 ä¸ª
- AI æœåŠ¡ï¼š3 ä¸ª
- æ•°æ®åº“ï¼š1 ä¸ª
- ç¼“å­˜ï¼š2 ä¸ª
- UI ç»„ä»¶ï¼š5 ä¸ª
- å·¥å…·åº“ï¼š10 ä¸ª

**å¼€å‘ä¾èµ–ï¼š** 13 ä¸ª
- æµ‹è¯•æ¡†æ¶ï¼š3 ä¸ª
- TypeScriptï¼š3 ä¸ª
- æ ·å¼å·¥å…·ï¼š2 ä¸ª
- å…¶ä»–ï¼š5 ä¸ª

---

## 8. æ€»ç»“

### 8.1 é¡¹ç›®äº®ç‚¹æ€»ç»“

1. **æ¶æ„è®¾è®¡**
   - æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼ŒèŒè´£åˆ†ç¦»
   - å·¥å‚æ¨¡å¼å®ç° AI æä¾›å•†åˆ‡æ¢
   - ä»“åº“æ¨¡å¼å®ç°æ•°æ®è®¿é—®æŠ½è±¡

2. **æ€§èƒ½ä¼˜åŒ–**
   - Redis ç¼“å­˜å‡å°‘ AI API è°ƒç”¨
   - æ•°æ®åº“è¿æ¥æ± å¤ç”¨
   - è¶…æ—¶æ§åˆ¶é˜²æ­¢è¯·æ±‚æŒ‚èµ·

3. **å¯é æ€§ä¿éšœ**
   - åŒæä¾›å•†é™çº§æœºåˆ¶
   - åŸå­æ“ä½œé˜²æ­¢æ•°æ®ä¸ä¸€è‡´
   - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—ç³»ç»Ÿ

4. **ä»£ç è´¨é‡**
   - TypeScript ä¸¥æ ¼ç±»å‹æ£€æŸ¥
   - Zod è¿è¡Œæ—¶éªŒè¯
   - ç»“æ„åŒ–æ—¥å¿—å’Œè¯·æ±‚è¿½è¸ª

5. **å¯è§‚æµ‹æ€§**
   - æ€§èƒ½æŒ‡æ ‡æ”¶é›†
   - æˆæœ¬è¿½è¸ªç³»ç»Ÿ
   - ç®¡ç†åå°ç»Ÿè®¡

### 8.2 æŠ€æœ¯æ ˆæ€»ç»“

- **å‰ç«¯**ï¼šNext.js 15 + React 19 + TypeScript 5
- **åç«¯**ï¼šNext.js Server + Node.js
- **æ•°æ®åº“**ï¼šMongoDB 8 + Mongoose
- **ç¼“å­˜**ï¼šRedis (Upstash)
- **è®¤è¯**ï¼šClerk
- **AI æœåŠ¡**ï¼šGoogle Gemini + OpenAI + Replicate
- **å­˜å‚¨**ï¼šCloudinary
- **æ”¯ä»˜**ï¼šPayPal

### 8.3 é¡¹ç›®è§„æ¨¡æ€»ç»“

- **ä»£ç è¡Œæ•°**ï¼šçº¦ 3,754 è¡Œ
- **é¡µé¢æ•°é‡**ï¼š6 ä¸ª
- **ç»„ä»¶æ•°é‡**ï¼š13 ä¸ª UI ç»„ä»¶ + 3 ä¸ª Context
- **API ç«¯ç‚¹**ï¼š3 ä¸ª REST API + 6 ä¸ª Server Actions
- **æ•°æ®æ¨¡å‹**ï¼š4 ä¸ª

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š** 2025-01-XX  
**é¡¹ç›®ç‰ˆæœ¬ï¼š** 0.1.0  
**ç»´æŠ¤è€…ï¼š** AI Image Chat Team

