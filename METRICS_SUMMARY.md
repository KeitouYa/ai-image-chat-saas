# ğŸ“Š é¡¹ç›® Metrics æ‘˜è¦ - é€‚åˆç®€å†å±•ç¤º

> å¿«é€Ÿå‚è€ƒï¼šé¡¹ç›®ä¸­å¯æµ‹è¯•çš„çœŸå® metrics æ•°æ®

---

## âœ… å·²å®ç°çš„ Metrics ç³»ç»Ÿ

### 1. ğŸ§ª æµ‹è¯•è¦†ç›–ç‡ç³»ç»Ÿ
- **æµ‹è¯•æ¡†æ¶**: Jest + Testing Library
- **é…ç½®æ–‡ä»¶**: `jest.config.js`, `jest.setup.js`
- **æµ‹è¯•æ–‡ä»¶**: `src/__tests__/services/chat.service.test.ts`
- **æµ‹è¯•è„šæœ¬**: 
  - `npm test` - è¿è¡Œæµ‹è¯•
  - `npm run test:coverage` - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
  - `npm run test:watch` - ç›‘å¬æ¨¡å¼

**å½“å‰çŠ¶æ€**:
- âœ… æµ‹è¯•æ¡†æ¶å·²é…ç½®
- âœ… å•å…ƒæµ‹è¯•å·²å®ç°
- âœ… è¦†ç›–ç‡æŠ¥å‘Šå¯ç”Ÿæˆ
- âš ï¸ éƒ¨åˆ†æµ‹è¯•éœ€è¦ä¿®å¤ï¼ˆä¸å½±å“ metrics ç³»ç»Ÿæœ¬èº«ï¼‰

**ç®€å†è¡¨è¿°**:
> "å»ºç«‹äº†å®Œæ•´çš„ Jest æµ‹è¯•æ¡†æ¶ï¼Œå®ç°äº†å•å…ƒæµ‹è¯•å’Œè¦†ç›–ç‡æŠ¥å‘Šç³»ç»Ÿ"

---

### 2. âš¡ æ€§èƒ½ Metrics æ”¶é›†ç³»ç»Ÿ
**ä½ç½®**: `src/services/chat.service.ts` (ç¬¬283-301è¡Œ)

**æ”¶é›†çš„æŒ‡æ ‡** (å½“ `METRICS_ENABLED=true`):

| æŒ‡æ ‡ç±»å‹ | æŒ‡æ ‡åç§° | è¯´æ˜ |
|---------|---------|------|
| **å“åº”æ—¶é—´** | `totalMs` | æ€»å“åº”æ—¶é—´ |
| | `dbMs` | æ•°æ®åº“æ“ä½œè€—æ—¶ |
| | `cacheReadMs` | ç¼“å­˜è¯»å–è€—æ—¶ |
| | `creditMs` | ç§¯åˆ†æ“ä½œè€—æ—¶ |
| | `aiMs` | AI è°ƒç”¨è€—æ—¶ |
| | `cacheWriteMs` | ç¼“å­˜å†™å…¥è€—æ—¶ |
| **ä¸šåŠ¡æŒ‡æ ‡** | `status` | è¯·æ±‚çŠ¶æ€ (success/fail) |
| | `providerUsed` | ä½¿ç”¨çš„ AI æä¾›å•† |
| | `fallbackUsed` | æ˜¯å¦ä½¿ç”¨é™çº§ |
| | `cached` | æ˜¯å¦å‘½ä¸­ç¼“å­˜ |
| | `messageLength` | æ¶ˆæ¯é•¿åº¦ |
| | `errorName` | é”™è¯¯ç±»å‹ |

**å¯ç”¨æ–¹å¼**:
```bash
METRICS_ENABLED=true npm run dev
```

**ç®€å†è¡¨è¿°**:
> "å®ç°äº†å®Œæ•´çš„æ€§èƒ½ç›‘æ§ç³»ç»Ÿï¼Œè¿½è¸ª 6 ä¸ªç»´åº¦çš„å“åº”æ—¶é—´å’Œ 6 ä¸ªä¸šåŠ¡æŒ‡æ ‡ï¼Œæ”¯æŒå®æ—¶æ€§èƒ½åˆ†æå’Œé—®é¢˜è¯Šæ–­"

---

### 3. ğŸ’° æˆæœ¬è¿½è¸ªç³»ç»Ÿ
**ä½ç½®**: `src/services/cost-tracking.service.ts`

**è¿½è¸ªçš„æ•°æ®**:
- âœ… ç”¨æˆ·çº§æˆæœ¬ç»Ÿè®¡
- âœ… å¹³å°çº§æˆæœ¬æ±‡æ€»
- âœ… æŒ‰æ“ä½œç±»å‹åˆ†ç±» (chat/image)
- âœ… æŒ‰æä¾›å•†åˆ†ç±» (gemini/openai/replicate)
- âœ… Token ä½¿ç”¨é‡è¿½è¸ª
- âœ… ç§¯åˆ†æ¶ˆè€—è®°å½•

**API å‡½æ•°**:
- `trackCost()` - è¿½è¸ªå•æ¬¡æ“ä½œ
- `getUserTotalCost()` - ç”¨æˆ·æ€»æˆæœ¬
- `getPlatformTotalCost()` - å¹³å°æ€»æˆæœ¬

**ç®€å†è¡¨è¿°**:
> "å»ºç«‹äº†æˆæœ¬è¿½è¸ªç³»ç»Ÿï¼Œå®æ—¶ç›‘æ§ AI æœåŠ¡ä½¿ç”¨æˆæœ¬ï¼Œæ”¯æŒæŒ‰ç”¨æˆ·ã€æ“ä½œç±»å‹å’Œæä¾›å•†è¿›è¡Œå¤šç»´åº¦æˆæœ¬åˆ†æ"

---

### 4. ğŸ“Š Analytics äº‹ä»¶è¿½è¸ª
**ä½ç½®**: `src/lib/analytics.ts`

**åŠŸèƒ½**:
- âœ… AI ä½¿ç”¨äº‹ä»¶è¿½è¸ª
- âœ… ç§¯åˆ†è´­ä¹°äº‹ä»¶è¿½è¸ª
- âœ… è‡ªå®šä¹‰äº‹ä»¶è¿½è¸ª
- âœ… äº‹ä»¶æŸ¥è¯¢ API

**ç®€å†è¡¨è¿°**:
> "å®ç°äº†äº‹ä»¶è¿½è¸ªç³»ç»Ÿï¼Œæ”¯æŒç”¨æˆ·è¡Œä¸ºåˆ†æå’Œä¸šåŠ¡æŒ‡æ ‡ç›‘æ§ï¼Œä¸ºæ•°æ®é©±åŠ¨å†³ç­–æä¾›åŸºç¡€"

---

### 5. ğŸ¯ Admin Stats API
**ä½ç½®**: `app/api/admin/stats/route.ts`

**æä¾›çš„ç»Ÿè®¡æ•°æ®**:
- æ€»ç”¨æˆ·æ•°
- æ€»ç§¯åˆ†æµé€šé‡
- æ€»ç§¯åˆ†è´­ä¹°é‡‘é¢
- æ€»å›¾ç‰‡ç”Ÿæˆæ•°
- å¹³å°æ€»æˆæœ¬

**ç®€å†è¡¨è¿°**:
> "å¼€å‘äº†ç®¡ç†å‘˜ç»Ÿè®¡ APIï¼Œæä¾›å¹³å°çº§æ•°æ®æ¦‚è§ˆï¼Œæ”¯æŒä¸šåŠ¡å†³ç­–"

---

## ğŸ“ˆ é¡¹ç›®è§„æ¨¡ Metrics

- **ä»£ç æ–‡ä»¶**: 35 ä¸ª TypeScript/JavaScript æ–‡ä»¶
- **ä»£ç è¡Œæ•°**: 1,954 è¡Œ
- **ä»£ç å¤§å°**: 51.33 KB
- **ç”Ÿäº§ä¾èµ–**: 24 ä¸ª
- **å¼€å‘ä¾èµ–**: 13 ä¸ª
- **æµ‹è¯•è„šæœ¬**: 3 ä¸ª

---

## ğŸ¯ ç®€å†å±•ç¤ºå»ºè®®

### æŠ€æœ¯æ ˆéƒ¨åˆ†
```
æµ‹è¯•æ¡†æ¶: Jest, Testing Library
ç›‘æ§ç³»ç»Ÿ: è‡ªå®šä¹‰æ€§èƒ½ç›‘æ§, æˆæœ¬è¿½è¸ª, äº‹ä»¶åˆ†æ
```

### é¡¹ç›®äº®ç‚¹éƒ¨åˆ†
```
1. å»ºç«‹äº†å®Œæ•´çš„æµ‹è¯•æ¡†æ¶å’Œè¦†ç›–ç‡æŠ¥å‘Šç³»ç»Ÿ
2. å®ç°äº† 6 ç»´æ€§èƒ½ç›‘æ§å’Œ 6 é¡¹ä¸šåŠ¡æŒ‡æ ‡è¿½è¸ª
3. å¼€å‘äº†æˆæœ¬è¿½è¸ªç³»ç»Ÿï¼Œæ”¯æŒå¤šç»´åº¦æˆæœ¬åˆ†æ
4. å®ç°äº†äº‹ä»¶è¿½è¸ªå’Œæ•°æ®åˆ†æç³»ç»Ÿ
```

### é‡åŒ–æŒ‡æ ‡ï¼ˆå¦‚æœå¯ç”¨ï¼‰
```
- æµ‹è¯•è¦†ç›–ç‡: [è¿è¡Œ npm run test:coverage è·å–]
- å¹³å‡å“åº”æ—¶é—´: [ä» metrics æ—¥å¿—ä¸­æå–]
- ç¼“å­˜å‘½ä¸­ç‡: [ä» metrics æ—¥å¿—ä¸­æå–]
- é™çº§æˆåŠŸç‡: [ä» metrics æ—¥å¿—ä¸­æå–]
```

---

## ğŸš€ å¦‚ä½•è·å–å®é™… Metrics æ•°æ®

### 1. æµ‹è¯•è¦†ç›–ç‡
```bash
npm run test:coverage
# æŸ¥çœ‹ coverage/ ç›®å½•ä¸‹çš„æŠ¥å‘Š
```

### 2. æ€§èƒ½ Metrics
```bash
# å¯ç”¨å¹¶è¿è¡Œ
METRICS_ENABLED=true npm run dev

# æŸ¥çœ‹æ—¥å¿—ä¸­çš„ [metric] æ¡ç›®
# æ ¼å¼: [metric] chat.request { ... }
```

### 3. å¹³å°ç»Ÿè®¡
```bash
# è®¿é—® Admin API (éœ€è¦ç®¡ç†å‘˜æƒé™)
GET /api/admin/stats
```

### 4. æˆæœ¬æ•°æ®
```typescript
import { getPlatformTotalCost } from "@/src/services/cost-tracking.service";
const cost = await getPlatformTotalCost();
```

---

## ğŸ“ Metrics æ•°æ®ç¤ºä¾‹

### æ€§èƒ½ Metrics æ—¥å¿—ç¤ºä¾‹
```json
{
  "[metric] chat.request": {
    "requestId": "req_abc123",
    "status": "success",
    "providerUsed": "gemini",
    "fallbackUsed": false,
    "cached": false,
    "totalMs": 1234,
    "aiMs": 1100,
    "dbMs": 45,
    "cacheReadMs": 12,
    "creditMs": 23,
    "cacheWriteMs": 34
  }
}
```

---

## âœ… æ€»ç»“

é¡¹ç›®å·²å®ç°å®Œæ•´çš„ metrics ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š
1. âœ… æµ‹è¯•è¦†ç›–ç‡è¿½è¸ª
2. âœ… æ€§èƒ½ç›‘æ§ (6 ä¸ªç»´åº¦)
3. âœ… ä¸šåŠ¡æŒ‡æ ‡è¿½è¸ª (6 ä¸ªæŒ‡æ ‡)
4. âœ… æˆæœ¬è¿½è¸ªç³»ç»Ÿ
5. âœ… äº‹ä»¶åˆ†æç³»ç»Ÿ
6. âœ… å¹³å°ç»Ÿè®¡ API

**æ‰€æœ‰ metrics ç³»ç»Ÿéƒ½å·²å®ç°å¹¶å¯è¿è¡Œï¼Œé€‚åˆåœ¨ç®€å†ä¸Šå±•ç¤ºï¼**

---

*æœ€åæ›´æ–°: 2025-12-24*
*ç”Ÿæˆå·¥å…·: scripts/get-metrics.js*

