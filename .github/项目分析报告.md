## 项目结构分析报告

这是一个 **AI 图像生成 + 聊天 SaaS 应用**，采用现代化的全栈架构。

### 技术栈

| 类别 | 技术 |
|------|------|
| 前端框架 | Next.js 15.5.4 (App Router) + React 19 |
| 语言 | TypeScript 5 |
| 数据库 | MongoDB 8 + Mongoose |
| 缓存 | Upstash Redis |
| 认证 | Clerk |
| UI | Radix UI + Tailwind CSS 4 |
| 支付 | PayPal |
| AI 服务 | Google Gemini (主) / OpenAI (备) / Replicate (图像) |
| 图像存储 | Cloudinary |

### 目录结构

```
├── app/                    # Next.js App Router
│   ├── api/                # API 路由 (chat, image, credits, admin)
│   ├── chat/               # 聊天页面
│   ├── dashboard/          # 用户仪表板
│   └── buy-credits/        # 购买积分页面
│
├── src/                    # 核心源代码 (分层架构)
│   ├── controllers/        # 控制器层 - 请求处理
│   ├── services/           # 服务层 - 业务逻辑
│   ├── repositories/       # 仓库层 - 数据访问
│   ├── models/             # MongoDB 数据模型
│   ├── schemas/            # Zod 验证模式
│   ├── providers/          # 外部服务提供商 (AI, DB)
│   ├── middlewares/        # 中间件 (速率限制, RBAC)
│   └── lib/                # 工具库 (日志, 缓存, 错误处理)
│
├── components/             # React 组件
│   ├── ui/                 # 基础 UI 组件
│   ├── forms/              # 表单组件
│   ├── cards/              # 卡片组件
│   └── nav/                # 导航组件
│
└── context/                # React Context 状态管理
```

### 核心功能

1. **AI 聊天** - 支持 Gemini/OpenAI 双提供商，自动故障转移，24小时缓存
2. **图像生成** - 使用 Replicate (Flux Schnell)，存储到 Cloudinary
3. **积分系统** - 原子操作防止超支，新用户 50 免费积分
4. **用户认证** - Clerk 集成，RBAC 三级角色 (USER/SUBSCRIBER/ADMIN)
5. **支付系统** - PayPal 集成

### 架构亮点

- **分层架构**: API Route → Controller → Service → Repository → Model
- **工厂模式**: AI 提供商动态切换
- **原子操作**: MongoDB `$gte` 操作符防止积分竞态条件
- **故障转移**: Gemini 失败自动降级到 OpenAI
- **超时保护**: AI 调用 30 秒，图像生成 2 分钟
- **请求追踪**: nanoid 生成唯一 requestId 贯穿全链路

### 数据模型

- **User**: userEmail, clerkUserId, role (USER/ADMIN/SUBSCRIBER)
- **Image**: userEmail, name (提示词), url (Cloudinary)
- **Credit**: userEmail, credits, amount

### 主要页面

| 路由 | 功能 |
|------|------|
| `/` | 首页 - 图像生成入口 |
| `/chat` | AI 聊天界面 |
| `/dashboard` | 用户图像列表 |
| `/buy-credits` | PayPal 购买积分 |

这是一个设计良好的 SaaS 应用，具备完整的用户认证、支付、AI 服务集成和可观测性基础设施。
